<h1><%= event.title %></h1>

<p>
  <%= event.description %>

  <% if can? :edit, event %>
    <%= link_to 'Edit', edit_event_path(event) %>
  <% end %>
</p>

<div class="row">
  <div class="col-sm-9">
    <% if event.has_attendee?(current_user) %>
      <% if event.has_chef?(current_user) %>
        <% if current_user.dishes_for(event) %>
          <div class="well">
            <h4 style="margin-top: 0">Your Entries:
              <small>
                <%= current_user.dishes_for(event).map {|entry| link_to entry.name, edit_event_entry_path(event, entry) }.join(', ').html_safe %>
              </small>
            </h4>
            <%= link_to 'Add another Dish', new_event_entry_path(event), class: 'btn btn-default btn-sm' %>
          </div>
        <% else %>
          <%= link_to 'Add your Dish', new_event_entry_path(event), class: 'btn btn-success' %>
        <% end %>
      <% end %>

      <h2>Eat Now. Rank as you go.</h2>
      <div class="row">
        <% event.categories.each do |cat| %>
          <div class="col-md-6">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title"><%= cat.name.gsub('Best ', '') %></h4>
              </div>
              <div class="panel-body">
                <% cat.entries.each do |entry| %>
                  <div class="entry-for-rating">
                    <strong><%= entry.name %></strong><br>
                    by <%= entry.owner.name %><br>
                    <div class="rateit-container">
                      <div class="rateit bigstars" data-entryid="<%= entry.id %>" data-rateit-value="<%= current_user.rating_for(entry).try(:score) %>" data-rateit-starwidth="32" data-rateit-starheight="32"></div>
                      <div class="rateit-status"></div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

    <% else %>
      <!-- Logged in, but not yet Attending -->
      <div>
        <h2>Are you here with an entry?</h2>
        <div class="row">
          <div class="col-sm-6">
            <%= render partial: 'attendances/form', locals: { event: event, gtype: 'chef' } %>
          </div>
          <div class="col-sm-6">
            <%= render partial: 'attendances/form', locals: { event: event, gtype: 'eater' } %>
          </div>
        </div>
      </div>
    <% end %>

    <% if can? :edit, event %>
      <div class="well" style="margin-top: 20px">
        <% if event.categories.present? %>
          <h4 style="margin-top: 0">Admin: Manage Categories</h4>
          <ul>
            <% event.categories.each do |cat| %>
              <li><%= link_to cat.name, edit_event_category_path(event, cat) %></li>
            <% end %>
          </ul>
        <% else %>
          <h2>No Categories Found!</h2>
        <% end %>
        <%= link_to 'Add a Category', new_event_category_path(event), class: 'btn btn-default' %>
      </div>
    <% end %>
  </div>

  <div class="col-sm-3">
    <p class="help-block">
      User ID: <strong><%= current_user.try(:id) %></strong><br>
      Type: <strong><%= current_user.guest_type_for(event).try(:capitalize) %></strong>
    </p>
    <p>
      <strong>Event date:</strong>
      <%= event.event_date %>
    </p>

    <p>
      <strong>Polls open:</strong>
      <%= event.polls_open %>
    </p>

    <p>
      <strong>Polls close:</strong>
      <%= event.polls_close %>
    </p>

    <% if can? :edit, event %>
      <h3>Guest List</h3>
      <% event.guests.each do |guest| %>
        <% if event.has_chef?(guest) %>
          <i class="fa fa-coffee"></i>
        <% end %>
        <%= guest.name %>
      <% end %>
    <% end %>
  </div>
</div>
